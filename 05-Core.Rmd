# Working with big data in R

## Read in CSV files

### Read one large CSV file 

(1) Read a CSV file with header
</center>
![](pic/tranall.png)
</center>
```{r}
library(data.table)

##It will take around 3 mins to read in 5,732,838 records with 105 variables
tran2<-fread("tranall2011_19.csv")

```



(2) Read a CSV file without header

```{r,eval=FALSE}

tran2<-fread("tranall2011_19.csv",header=F)

```

(3) Read a CSV file with the second row as header and dropping the first row
<center>

![](pic/sepc.png)
</center>
```{r}

epcdata1<-fread("D_EPC_data_2012_Q4_extract_0221.csv", skip = 1)
epcdata14<-read.csv("D_EPC_data_2020_Q4_extract_0221.csv", skip = 1)

```


### Fast reading multiple EPC csv files together in R

(1) Code for reading in EPCs in England and Wales
```{r,eval=FALSE}
## assume all the unzipped EPC stored in EPC folder in D drive


x1 <- list.files(path = ".", pattern = NULL, all.files = FALSE,
                 full.names = FALSE, recursive = FALSE)


datalist <- paste("D:/EPC",x1,"certificates.csv",sep="/")

epcdata = data.table::rbindlist(lapply(datalist, data.table::fread, showProgress = FALSE))

```

(2) Code for reading in EPCs in Scotland

```{r,eval=FALSE}
datalist = list.files(pattern="*.csv")

epcdata = data.table::rbindlist(lapply(datalist, data.table::fread, skip=1,showProgress = FALSE))

```


## Basic larger dataset munging/wrangling
### Select columns

```{r}

class(tran2)

needlist<-c("transactionid","postcode","price","dateoftransfer","propertytype","laua","lad11nm","tfarea","priceper","TRANSACTION_TYPE")

tran2<-tran2[,..needlist]

head(tran2)
```


### Changing column names to lower case or upper case
#### Changing column names to lower case
```{r}

setnames(tran2, tolower(names(tran2)))

head(tran2)

```


#### Changing column names to upper case

```{r,eval=FALSE}

setnames(tran2, toupper(names(tran2)))

```


### Filter rows based on conditions

```{r}

tran2[laua=="E09000007", ]

Camden<-tran2[laua=="E09000007", ]
head(Camden)
```

### Add in the ID column
```{r}

Camden[,tranid := .I]
head(Camden)

#Camden[, tranid := .I+1000000]
```

### Convert datatable values to uppercase
```{r}

Camden[,  `:=`(tran_type = toupper(transaction_type))]
head(Camden)
```

### Delete columns


```{r}

Camden[,transaction_type:=NULL]

head(Camden)
```



### Join datasets

```{r}

#epcdata<-rbind(epcdata13,epcdata14)

```

### Remove Duplicates
```{r}

dim(Camden)

unique(Camden)

dim(Camden)

```




### Write files
```{r,eval=FALSE}

fwrite(Camden,"Camden.csv")

```



## Work with PostGIS database in R
### Write files to PostGIS
```{r,eval=FALSE}

drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "casa",port=5432, user="postgres",password=******)
dbWriteTable(con, "Camden",value=Camden, append = TRUE, row.names = FALSE)

```


### Read files from PostGIS
```{r,eval=FALSE}

drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "casa",port=5432, user="postgres",password=******)
tran<- dbGetQuery(con,"select * from Camden") 

```


## Measure code performance

### 


###

## Execute R code in Alteryx 